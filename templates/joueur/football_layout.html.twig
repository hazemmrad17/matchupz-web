{% extends 'base.html.twig' %}

{% block title %}Football Team Layout{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('/vendor/css/football_layout.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Add Boxicons for the toast icon -->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
{% endblock %}

{% block body %}
<main>
    <!-- Toast Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="invalidDropToast" class="bs-toast toast toast-placement-ex m-2 fade hide" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000">
            <div class="toast-header">
                <i class="bx bx-bell me-2"></i>
                <div class="me-auto fw-semibold">Erreur de Placement</div>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <!-- Message will be set by JavaScript -->
            </div>
        </div>
    </div>

    <div class="static">
        <h1 class="js-heading">FOOTBALL FORMATION</h1>
        <p class="js-subheading">Drag players onto the field to build your team.<br><span style="font-size: 11px">Ensure players match their position roles.</span></p>
        
        <!-- Add Toast Color Selector -->
        <div class="toast-color-selector mb-3">
            <label for="toastColorSelect">Toast Color:</label>
            <select id="toastColorSelect" class="form-select color-dropdown">
                <option value="bg-danger" selected>Danger (Red)</option>
                <option value="bg-primary">Primary (Blue)</option>
                <option value="bg-success">Success (Green)</option>
                <option value="bg-warning">Warning (Yellow)</option>
                <option value="bg-info">Info (Cyan)</option>
            </select>
        </div>

        <div class="formation-selector">
            <form method="get" action="{{ path('football_layout') }}">
                <label for="formation">Select Formation:</label>
                <select name="formation" id="formationSelect" onchange="this.form.submit()">
                    {% for formation in formations %}
                        <option value="{{ formation }}" {{ formation == selected_formation ? 'selected' : '' }}>{{ formation }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="player-list">
            <h5>Available Players</h5>
            <p>Debug: {{ joueurs|length }} players found.</p>

            {% set positionMapping = {
                'Gardien': ['GK'],
                'DÃ©fenseur': ['RB', 'LB', 'RWB', 'LWB', 'SW'],
                'Milieu': ['DM', 'CM', 'AM', 'RM', 'LM'],
                'Attaquant': ['RW', 'LW', 'CF', 'ST', 'SS']
            } %}

            {% for position, roles in positionMapping %}
                <h6>{{ position }}s</h6>
                {% set hasPlayers = false %}
                {% for joueur in joueurs %}
                    {% if joueur.poste is not empty %}
                        {% set matchesRole = false %}
                        {% for role in roles %}
                            {% if joueur.poste|lower == role|lower %}
                                {% set matchesRole = true %}
                            {% endif %}
                        {% endfor %}
                        {% if matchesRole %}
                            {% set hasPlayers = true %}
                            <p>Debug: Player {{ joueur.nom }} - Poste: {{ joueur.poste }}, Category: {{ position }}</p>
                            <div class="player-item" draggable="true" 
                                 data-player-id="{{ joueur.idJoueur }}" 
                                 data-position="{{ joueur.poste|trim }}"
                                 data-category="{{ position|trim }}"
                                 data-name="{{ (joueur.nom ~ ' ' ~ joueur.prenom)|trim }}"
                                 data-img="{{ joueur.profilePicture ? asset('/Uploads/profile_pictures/' ~ joueur.profilePicture) : asset('/Uploads/photos/default_avatar.png') }}"
                                 data-goals="{{ joueur.performanceJoueur ? joueur.performanceJoueur.butsMarques : 0 }}"
                                 data-matches="{{ joueur.performanceJoueur ? joueur.performanceJoueur.minutesJouees // 90 : 0 }}"
                                 data-height="{{ joueur.taille ? joueur.taille ~ 'm' : 'N/A' }}">
                                <img src="{{ joueur.profilePicture ? asset('/Uploads/profile_pictures/' ~ joueur.profilePicture) : asset('/Uploads/photos/default_avatar.png') }}" 
                                     alt="{{ joueur.nom }}" 
                                     onerror="this.onerror=null; this.src='{{ asset('/Uploads/photos/default_avatar.png') }}';">
                                <span>
                                    {{ joueur.nom ~ ' ' ~ joueur.prenom }} ({{ joueur.poste }})
                                    <span style="display: inline-block; width: 15px; height: 15px; background-color: {{ joueur.statut == 'Actif' ? 'green' : 'red' }}; margin-left: 5px; vertical-align: middle;"></span>
                                </span>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {% if not hasPlayers %}
                    <p class="no-players">No {{ position|lower }}s available.</p>
                {% endif %}
            {% endfor %}

            <h6>Other Players (No Position Specified)</h6>
            {% set hasOthers = false %}
            {% for joueur in joueurs %}
                {% if joueur.poste is empty %}
                    {% set hasOthers = true %}
                    <div class="player-item" draggable="false" 
                         data-player-id="{{ joueur.idJoueur }}" 
                         data-position="Unknown"
                         data-category="Unknown"
                         data-name="{{ (joueur.nom ~ ' ' ~ joueur.prenom)|trim }}"
                         data-img="{{ joueur.profilePicture ? asset('/Uploads/profile_pictures/' ~ joueur.profilePicture) : asset('/Uploads/photos/default_avatar.png') }}"
                         data-goals="{{ joueur.performanceJoueur ? joueur.performanceJoueur.butsMarques : 0 }}"
                         data-matches="{{ joueur.performanceJoueur ? joueur.performanceJoueur.minutesJouees // 90 : 0 }}"
                         data-height="{{ joueur.taille ? joueur.taille ~ 'm' : 'N/A' }}">
                        <img src="{{ joueur.profilePicture ? asset('/Uploads/profile_pictures/' ~ joueur.profilePicture) : asset('/Uploads/photos/default_avatar.png') }}" 
                             alt="{{ joueur.nom }}" 
                             onerror="this.onerror=null; this.src='{{ asset('/Uploads/photos/default_avatar.png') }}';">
                        <span>
                            {{ joueur.nom ~ ' ' ~ joueur.prenom }} (No Position)
                            <span style="display: inline-block; width: 15px; height: 15px; background-color: {{ joueur.statut == 'Actif' ? 'green' : 'red' }}; margin-left: 5px; vertical-align: middle;"></span>
                        </span>
                    </div>
                {% endif %}
            {% endfor %}
            {% if not hasOthers %}
                <p class="no-players">No players without a position.</p>
            {% endif %}
        </div>
    </div>
    <div class="js-stage stage texture">
        <div class="js-world world">
            <div class="team js-team">
                <!-- Formation positions will be populated by JavaScript -->
            </div>
            <div class="terrain js-terrain">
                <div class="field field--alt"></div>
                <div class="field ground">
                    <div class="field__texture field__texture--gradient"></div>
                    <div class="field__texture field__texture--gradient-b"></div>
                    <div class="field__texture field__texture--grass"></div>
                    <div class="field__line field__line--goal"></div>
                    <div class="field__line field__line--goal field__line--goal--far"></div>
                    <div class="field__line field__line--outline"></div>
                    <div class="field__line field__line--penalty"></div>
                    <div class="field__line field__line--penalty-arc"></div>
                    <div class="field__line field__line--penalty-arc field__line--penalty-arc--far"></div>
                    <div class="field__line field__line--mid"></div>
                    <div class="field__line field__line--circle"></div>
                    <div class="field__line field__line--penalty field__line--penalty--far"></div>
                </div>
                <div class="field__side field__side--front"></div>
                <div class="field__side field__side--left"></div>
                <div class="field__side field__side--right"></div>
                <div class="field__side field__side--back"></div>
            </div>
        </div>
        <div class="loading js-loading">PLEASE WAIT...</div>
    </div>
</main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.2/velocity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ asset('/vendor/js/football_layout.js') }}"></script>
{% endblock %}